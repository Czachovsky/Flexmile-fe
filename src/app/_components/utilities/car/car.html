<div class="car-card card-{{cardSize()}}" (click)="goToOffer(offer().id)">
  <div class="car-card__badges">
    @if (!offer().available) {
      <flexmile-badge [type]="badgeTypes.RESERVED" [size]="cardSize()"></flexmile-badge>
    } @else {
      @if (offer().attributes.popular) {
        <flexmile-badge [type]="badgeTypes.HOT" [size]="cardSize()"></flexmile-badge>
      }
      @if (offer().attributes.available_immediately) {
        <flexmile-badge [type]="badgeTypes.AVAILABLE" [size]="cardSize()"></flexmile-badge>
      }
      @if (offer().attributes.coming_soon) {
        <flexmile-badge [type]="badgeTypes.SOON" [date]="offer().coming_soon_date" [size]="cardSize()"></flexmile-badge>
      }
      @if (offer().attributes.new) {
        <flexmile-badge [type]="badgeTypes.NEW" [size]="cardSize()"></flexmile-badge>
      }
    }
  </div>

  @if (cardSize() !== badgeSizes.LG || (cardSize() === badgeSizes.LG && !screen.isMobile())) {
    <ng-container *ngTemplateOutlet="imageTemplate"></ng-container>
  }

  <div class="car-card__content xlg:p-4 p-3">
    <div class="car-card__header mb-2">
      <h3 class="car-card__title">{{ offer().brand.name }} {{ offer().model }}</h3>
      <p class="car-card__subtitle">{{ offer().engine }}</p>
    </div>

    <div class="car-card__specs pb-3">
      <div class="car-card__spec flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
          <path
            d="M9.71094 6.5H15.9609C17.3672 6.5 18.5 7.63281 18.5 9V16.5H19.125C20.8438 16.5 22.25 17.9062 22.25 19.625V21.5C22.25 22.2031 22.7969 22.75 23.5 22.75C24.1641 22.75 24.75 22.2031 24.75 21.5V15.25C23.3438 15.25 22.25 14.1562 22.25 12.75V9.82031L21.1953 8.84375C20.9219 8.60938 20.9219 8.21875 21.1562 7.98438C21.3906 7.71094 21.7812 7.71094 22.0156 7.94531L25.1797 10.7969C25.6875 11.3047 26 11.9688 26 12.6719V21.5C26 22.9062 24.8672 24 23.5 24C22.0938 24 21 22.9062 21 21.5V19.625C21 18.6094 20.1406 17.75 19.125 17.75H18.5V25.25H19.125C19.4375 25.25 19.75 25.5625 19.75 25.875C19.75 26.2266 19.4375 26.5 19.125 26.5H6.625C6.27344 26.5 6 26.2266 6 25.875C6 25.5625 6.27344 25.25 6.625 25.25H7.25V9C7.25 7.63281 8.34375 6.5 9.75 6.5H9.71094ZM15.9609 7.75H9.71094C9.04688 7.75 8.46094 8.33594 8.46094 9V14H17.25V9C17.25 8.33594 16.6641 7.75 15.9609 7.75ZM17.25 15.25H8.46094V25.25H17.25V15.25ZM24.75 14V12.6719C24.75 12.3203 24.5938 11.9688 24.3203 11.7344L23.5 10.9531V12.75C23.5 13.4531 24.0469 14 24.75 14Z"
            fill="#863087"/>
        </svg>
        <span>{{ getFuelLabel(offer().fuel_type) }}</span>
      </div>
      <div class="car-card__spec flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path
            d="M24 3.3C24 1.4625 22.5375 0 20.7 0C18.8625 0 17.4 1.4625 17.4 3.3C17.4 4.8375 18.4875 6.15 19.95 6.4875V11.25H12.75V6.4875C14.2125 6.15 15.3 4.8375 15.3 3.3C15.3 1.4625 13.8 0 12 0C10.2 0 8.7 1.4625 8.7 3.3C8.7 4.8375 9.7875 6.15 11.25 6.4875V11.25H4.05V6.4875C5.5125 6.15 6.6 4.8375 6.6 3.3C6.6 1.5 5.1375 0 3.3 0C1.4625 0 0 1.4625 0 3.3C0 4.8375 1.0875 6.15 2.55 6.4875V17.5125C1.0875 17.85 0 19.1625 0 20.7C0 22.5375 1.4625 24 3.3 24C5.1375 24 6.6 22.5375 6.6 20.7C6.6 19.1625 5.5125 17.85 4.05 17.5125V12.75H11.25V17.5125C9.7875 17.85 8.7 19.1625 8.7 20.7C8.7 22.5 10.1625 24 12 24C13.8375 24 15.3 22.5375 15.3 20.7C15.3 19.1625 14.2125 17.85 12.75 17.5125V12.75H20.7C21.1125 12.75 21.45 12.4125 21.45 12V6.4875C22.9125 6.15 24 4.8375 24 3.3ZM1.5 3.3C1.5 2.2875 2.2875 1.5 3.3 1.5C4.3125 1.5 5.1 2.2875 5.1 3.3C5.1 4.275 4.3125 5.1 3.3 5.1C2.2875 5.1 1.5 4.275 1.5 3.3ZM5.0625 20.7C5.0625 21.675 4.275 22.5 3.2625 22.5C2.25 22.5 1.5 21.7125 1.5 20.7C1.5 19.725 2.2875 18.9 3.3 18.9C4.3125 18.9 5.0625 19.725 5.0625 20.7ZM10.2 3.3C10.2 2.2875 11.025 1.5 12 1.5C12.975 1.5 13.8 2.2875 13.8 3.3C13.8 4.275 13.0125 5.1 12 5.1C10.9875 5.1 10.2 4.275 10.2 3.3ZM13.8 20.7C13.8 21.675 13.0125 22.5 12 22.5C10.9875 22.5 10.2 21.7125 10.2 20.7C10.2 19.725 10.9875 18.9 12 18.9C13.0125 18.9 13.8 19.725 13.8 20.7ZM20.7 5.0625C19.725 5.0625 18.9 4.275 18.9 3.2625C18.9 2.2875 19.6875 1.4625 20.7 1.4625C21.7125 1.4625 22.5 2.2875 22.5 3.3C22.5 4.275 21.7125 5.0625 20.7 5.0625Z"
            fill="#863087"/>
        </svg>
        <span>{{ getTransmissionLabel(offer().transmission) }}</span>
      </div>
      <div class="car-card__spec flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
          <path
            d="M11.9375 16.5C11.9375 17.0469 11.5078 17.4375 11 17.4375C10.4531 17.4375 10.0625 17.0469 10.0625 16.5C10.0625 15.9922 10.4531 15.5625 11 15.5625C11.5078 15.5625 11.9375 15.9922 11.9375 16.5ZM13.8125 16.5C13.8125 15.9922 14.2031 15.5625 14.75 15.5625C15.2578 15.5625 15.6875 15.9922 15.6875 16.5C15.6875 17.0469 15.2578 17.4375 14.75 17.4375C14.2031 17.4375 13.8125 17.0469 13.8125 16.5ZM19.4375 16.5C19.4375 17.0469 19.0078 17.4375 18.5 17.4375C17.9531 17.4375 17.5625 17.0469 17.5625 16.5C17.5625 15.9922 17.9531 15.5625 18.5 15.5625C19.0078 15.5625 19.4375 15.9922 19.4375 16.5ZM19.75 9.625C19.75 9.97656 19.4375 10.25 19.125 10.25H16V11.5H18.9688C19.4766 11.5 19.9453 11.6562 20.375 11.9297L22.3672 13.2578C23.0703 13.7266 23.5 14.5078 23.5 15.3672V21.5C23.5 22.9062 22.3672 24 21 24H13.4219C12.6797 24 11.9375 23.6875 11.4688 23.0625L10.2188 21.5H9.125C8.07031 21.5 7.25 20.6797 7.25 19.625V17.125H4.75V20.25C4.75 20.6016 4.4375 20.875 4.125 20.875C3.77344 20.875 3.5 20.6016 3.5 20.25V12.75C3.5 12.4375 3.77344 12.125 4.125 12.125C4.4375 12.125 4.75 12.4375 4.75 12.75V15.875H7.25V13.375C7.25 12.3594 8.07031 11.5 9.125 11.5H14.75V10.25H11.625C11.2734 10.25 11 9.97656 11 9.625C11 9.3125 11.2734 9 11.625 9H19.125C19.4375 9 19.75 9.3125 19.75 9.625ZM9.125 12.75C8.77344 12.75 8.5 13.0625 8.5 13.375V19.625C8.5 19.9766 8.77344 20.25 9.125 20.25H10.8438L12.4453 22.2812C12.6797 22.5938 13.0703 22.75 13.4219 22.75H21C21.6641 22.75 22.25 22.2031 22.25 21.5V15.3672C22.25 14.9375 22.0156 14.5469 21.6641 14.3125L19.6719 12.9844C19.4766 12.8281 19.2031 12.75 18.9688 12.75H9.125ZM24.75 15.25C24.75 14.5859 25.2969 14 26 14H27.25C27.9141 14 28.5 14.5859 28.5 15.25V22.75C28.5 23.4531 27.9141 24 27.25 24H26C25.2969 24 24.75 23.4531 24.75 22.75V15.25ZM26 22.75H27.25V15.25H26V22.75Z"
            fill="#863087"/>
        </svg>
        <span>{{ offer().engine_capacity }} cm³ / {{ offer().horsepower }}KM</span>
      </div>
    </div>

    @if (cardSize() === badgeSizes.LG && screen.isMobile()) {
      <ng-container *ngTemplateOutlet="imageTemplate"></ng-container>
    }

    <div class="car-card__price pb-3">
      <span class="car-card__price-label">już od </span>
      <span class="car-card__price-amount">{{ offer().price_from }}</span>
      <span class="car-card__price-label"> PLN/ netto mies.</span>
    </div>
    @if (cardSize() === badgeSizes.LG) {
      <div class="btn_wrapper" [ngClass]="{'_p' : checkIfAnyTrue()}">
        <flexmile-button (clicked)="goToOfferList()" label="Sprawdź ofertę" iconPosition="right" icon="pi-arrow-right"
                         btnClass="w-full lg:w-auto"></flexmile-button>
      </div>
    }
    @if (cardSize() !== badgeSizes.LG && checkIfAnyTrue()) {
      <ng-container *ngTemplateOutlet="offerFeatures"></ng-container>
    }
  </div>
  @if (cardSize() === badgeSizes.LG && checkIfAnyTrue()) {
    <ng-container *ngTemplateOutlet="offerFeatures"></ng-container>
  }
</div>

<ng-template #offerFeatures>
  <div class="car-card__features" (click)="showFeatures($event)">
    @if (cardSize() !== badgeSizes.LG) {
      <div class="car-card__feature-label hidden xl:flex">
        Usługi w cenie:
      </div>
      <div class="car-card__feature-label flex xl:hidden">
        W cenie:
      </div>
    }

    @if (screen.isMobile()) {
      <ng-container *ngTemplateOutlet="mobileFeatures"></ng-container>
    } @else {
      <ng-container *ngTemplateOutlet="desktopFeatures"></ng-container>
    }
  </div>
</ng-template>

<ng-template #imageTemplate>
  <div class="car-card__image-wrapper xlg:px-4 px-3 xlg:pt-4 pt-3">
    @if (offer().image) {
      <img [src]="offer().image"
           [alt]="offer().brand.name + ' ' + offer().model + ' - ' + offer().engine + ', ' + offer().engine_capacity + ' cm³'"
           class="car-card__image block" [loading]="disableLazyLoad() ? 'eager' : 'lazy'" decoding="async"
           fetchpriority="low">
    } @else {
      <img src="/layout/images/no-image.png" [alt]="offer().brand.name + ' ' + offer().model + ' - brak zdjęcia'"
           class="car-card__image block" [loading]="disableLazyLoad() ? 'eager' : 'lazy'" decoding="async"
           fetchpriority="low">
    }
  </div>
</ng-template>

<ng-template #mobileFeatures>
  @for (f of offerListFeatures; track f) {
    @if (offer().additional_services[f.id].enabled) {
      <div class="car-card__feature-btn flex align-items-center justify-content-center"
           [innerHTML]="f.icon | sanitize: 'html'"></div>
    }
  }
</ng-template>
<ng-template #desktopFeatures>
  @for (f of offerListFeatures; track f) {
    @if (offer().additional_services[f.id].enabled) {
      <flexmile-tooltip [config]="{text: offer().additional_services[f.id].title, position: 'top', appendTo: 'body'}">
        <div class="car-card__feature-btn flex align-items-center justify-content-center"
             [innerHTML]="f.icon | sanitize: 'html'">
        </div>
      </flexmile-tooltip>
    }
  }
</ng-template>

@if (checkIfAnyTrue() && screen.isMobile() && featuresState) {
  <div class="features_mobile_overlay"
       @fadeInOut
       (click)="featuresState = false"></div>
  <div class="features_mobile" @slideUpDown>
    <div class="features_mobile-header">
      <div class="features_mobile-title">
        W racie najmu <br>od flexmile!
      </div>
      <div class="features_mobile-hide" (click)="featuresState = false">
        <i class="pi pi-times"></i>
      </div>
    </div>
    <div class="features_mobile-list">
      @for (f of offerListFeatures; track f) {
        @if (offer().additional_services[f.id].enabled) {
          <div class="feature">
            <div [innerHTML]="f.icon | sanitize: 'html'"></div>
            <span>{{ offer().additional_services[f.id].title }}</span>
          </div>
        }
      }
    </div>
  </div>
}
